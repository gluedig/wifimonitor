#include <time.h>
#include "ApDb.h"
bool ApDb::inDb(Tins::Dot11::address_type mac)
{
        return db.count(mac);
}


bool ApDb::newApEvent(ClientInfo *info)
{
        if (info->mac == null_address || info->mac == Tins::Dot11::BROADCAST)
                return false;

        db_mutex.lock();
/*
        if (!ap_set.count(info->mac)) {
//		std::cout << "New AP MAC: " << info->mac << " SSID: " << beacon->ssid() << " RSSI: " << (int)info->rssi <<
//			 " Channel: " << (int)beacon->ds_parameter_set() << std::endl;
//TODO: send to proper place
//TODO: use proper id
                ApEventMessage msg(EventMessage::AP_ADD, 1, info->mac,
                                   (int)info->rssi, (int)beacon->ds_parameter_set(), beacon->ssid());
                std::cout << msg.serialize() << std::endl;

        }
        ap_set.insert(info->mac);
*/

        if (inDb(info->mac)) {
                bool send_update = false;
                ApData data = db[info->mac];
                data.age = 0;
                if (data.ssid != info->asked_SSID) {
                        data.ssid = info->asked_SSID;
                        send_update = true;
                }
                if (data.channel != info->channel) {
                        data.channel = info->channel;
                        send_update = true;
                }
                db[info->mac] = data;

                if (send_update) {
//TODO: use proper id
                        ApEventMessage msg(EventMessage::AP_UPDATE, 1, data.mac,
                                               data.rssi, data.channel, data.ssid);
                        std::cout << msg.serialize() << std::endl;
                        sender->sendMessage(msg);
                }
               


        } else {
                ApData new_data;
                new_data.mac = info->mac;
                new_data.rssi = (int)info->rssi;
                new_data.channel = info->channel;
                new_data.first_seen = info->timestamp.seconds();
                if (info->asked_SSID.size())
                        new_data.ssid = info->asked_SSID;

                added++;
                db.insert(std::pair<Tins::Dot11::address_type, ApData>(info->mac, new_data));
                ApEventMessage msg(EventMessage::AP_UPDATE, 1, data.mac,
                                               data.rssi, data.channel, data.ssid);
                std::cout << msg.serialize() << std::endl;
                sender->sendMessage(msg);
      }
        db_mutex.unlock();

        return true;
}

void ApDb::cleanup(int maxage)
{
        db_mutex.lock();
        auto it = db.begin();
        while (it != db.end()) {
                it->second.age++;
                if (it->second.age > maxage) {
//			std::cout << "Removing " << it->second << std::endl;
//TODO: use proper id
                        ApEventMessage msg(EventMessage::AP_REMOVE, 1, it->second.mac,
                                               it->second.rssi, it->second.channel, it->second.ssid);
                        std::cout << msg.serialize() << std::endl;
                        sender->sendMessage(msg);

                        removed++;
                        db.erase(it++);
                } else {
                        ++it;
                }
        }

        db_mutex.unlock();
}

ApDb::ApDb(EventSender *_sender) : sender(_sender), added(0), removed(0)
{

}

std::ostream &operator<<(std::ostream &os, const ApDb &obj)
{
        const std::map<Tins::Dot11::address_type, ApData> *db = &(obj.db);
        std::map<Tins::Dot11::address_type, ApData>::const_iterator it;

        os << "ApDb dump, elements: " << db->size() << " added: " << obj.added << " removed: " << obj.removed << std::endl;
        for ( it = db->begin(); it != db->end(); ++it) {
                os << it->second << std::endl;
        }

        return os;
}

std::ostream &operator<<(std::ostream &os, const ApData &obj)
{
        os << "AP MAC: " << obj.mac << "\n\tRSSI: " << obj.rssi;
        os << "\n\tFirst seen: " << ctime(&obj.first_seen);
        os << "\tSSID: " << obj.ssid << "\n\tChannel: " << obj.channel;

        return os;
}

